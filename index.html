<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صحتي AI - المساعد الذكي للصحة النفسية</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans Arabic', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 500px;
            height: 750px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .ai-badge {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 10px;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .learning-indicator {
            width: 8px;
            height: 8px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .ai-header h1 {
            font-size: 32px;
            margin-bottom: 5px;
            font-weight: 700;
        }

        .ai-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .research-status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .research-activity {
            display: none;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 12px;
            animation: slideDown 0.5s ease-out;
        }

        .research-activity.active {
            display: block;
        }

        .knowledge-base {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 12px 20px;
            font-size: 13px;
            text-align: center;
            display: none;
        }

        .knowledge-base.show {
            display: block;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            animation: fadeInUp 0.4s ease-out;
        }

        .message.user {
            justify-content: flex-start;
        }

        .message.ai {
            justify-content: flex-end;
        }

        .message.research {
            justify-content: center;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            margin: 0 10px;
        }

        .user-avatar {
            background: #007AFF;
            color: white;
        }

        .ai-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .research-avatar {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
            line-height: 1.5;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #007AFF 0%, #0056D3 100%);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.ai .message-content {
            background: white;
            color: #333;
            border-bottom-left-radius: 5px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .message.research .message-content {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border-radius: 15px;
            max-width: 90%;
            text-align: center;
        }

        .research-source {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 11px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }

        .research-citation {
            font-style: italic;
            font-size: 11px;
            opacity: 0.8;
            margin-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            padding-top: 8px;
        }

        .thinking-indicator {
            display: none;
            align-items: center;
            padding: 15px;
            margin-left: 10px;
            font-size: 13px;
            color: #666;
        }

        .thinking-indicator.research {
            color: #ff6b6b;
        }

        .thinking-dots {
            margin-left: 10px;
        }

        .thinking-dots span {
            height: 8px;
            width: 8px;
            background: currentColor;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: thinking 1.4s infinite;
        }

        .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes thinking {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }

        .learning-panel {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 15px 20px;
            display: none;
            font-size: 13px;
        }

        .learning-panel.active {
            display: block;
        }

        .learning-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }

        .ai-controls {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .ai-btn.research {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .ai-btn.learning {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #eee;
        }

        .chat-input {
            display: flex;
            align-items: center;
            background: #f8f9fa;
            border-radius: 25px;
            padding: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .chat-input.ai-mode {
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .chat-input input {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            background: transparent;
            text-align: right;
            direction: rtl;
        }

        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            margin-right: 5px;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .knowledge-sources {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .sources-panel {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .source-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .source-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .source-description {
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }

        .source-url {
            color: #667eea;
            font-size: 12px;
            margin-top: 8px;
        }

        .crisis-banner {
            display: none;
            background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 14px;
            animation: slideDown 0.5s ease-out;
        }

        .crisis-banner a {
            color: white;
            text-decoration: underline;
            font-weight: bold;
        }

        .quick-replies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #eee;
            justify-content: center;
        }

        .quick-reply {
            padding: 10px 16px;
            border: 2px solid #667eea;
            border-radius: 25px;
            background: white;
            color: #667eea;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .quick-reply:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        @media (max-width: 480px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
                max-width: 100%;
            }
            
            .message-content {
                max-width: 85%;
            }
            
            .ai-controls {
                flex-direction: column;
            }
            
            .ai-btn {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="ai-header">
            <div class="header-controls">
                <div class="ai-badge">
                    <div class="learning-indicator"></div>
                    AI متعلم
                </div>
                <button class="ai-btn" onclick="toggleKnowledgeSources()" style="padding: 5px 12px; font-size: 10px;">مصادر المعرفة</button>
            </div>
            <h1>🧠 صحتي AI</h1>
            <p>المساعد الذكي المتعلم للصحة النفسية</p>
            <div class="research-status">
                <span>قاعدة البيانات: <strong id="knowledgeCount">1,247</strong> مصدر</span>
                <span>حالة التعلم: <strong id="learningStatus">نشط</strong></span>
            </div>
        </div>

        <div class="crisis-banner" id="crisisBanner">
            ⚠️ إلا كنتي كتفكر فشي حاجة خطيرة، عافاك تواصل مع الخط الساخن: <a href="tel:0537686464">0537-686464</a>
        </div>

        <div class="research-activity" id="researchActivity">
            🔍 جاري البحث في المكتبات العلمية... الرجاء الانتظار
        </div>

        <div class="knowledge-base" id="knowledgeBase">
            📚 تم العثور على 3 مصادر جديدة من مجلة الطب النفسي الحديث
        </div>

        <div class="learning-panel" id="learningPanel">
            <div>🎯 نمط التعلم النشط: تحليل المحادثة وتحسين الاستجابات</div>
            <div class="learning-stats">
                <div class="stat-item">
                    <div class="stat-number" id="sessionsCount">156</div>
                    <div class="stat-label">جلسات</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracyRate">94%</div>
                    <div class="stat-label">دقة</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="learningRate">+12</div>
                    <div class="stat-label">تعلم/يوم</div>
                </div>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                <div class="message-avatar ai-avatar">🤖</div>
                <div class="message-content">
                    مرحباً! أنا المساعد الذكي المتطور للصحة النفسية. 
                    أستطيع البحث في آلاف المصادر العلمية والتعلم من كل محادثة لتقديم أفضل المساعدة.
                    كيف يمكنني مساعدتك اليوم؟ 😊
                    <div class="research-citation">مدعوم بـ 1,247 مصدر علمي محدث</div>
                </div>
            </div>
        </div>
        
        <div class="thinking-indicator" id="thinkingIndicator">
            <span>🤔 جاري التفكير والتحليل</span>
            <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="thinking-indicator research" id="researchIndicator" style="display: none;">
            <span>🔍 جاري البحث في المكتبات العلمية</span>
            <div class="thinking-dots">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>

        <div class="quick-replies" id="quickReplies">
            <div class="quick-reply" onclick="sendQuickReply('مقلق بزاف ومكنقدرش نرتاح')">قلق شديد 😰</div>
            <div class="quick-reply" onclick="sendQuickReply('حاس براسي وحيد ومعنديش حد')">وحدة قاسية 😔</div>
            <div class="quick-reply" onclick="sendQuickReply('معنديش نعس ومفكر بزاف')">مشاكل النوم 😴</div>
            <div class="quick-reply" onclick="sendQuickReply('خاصني شي حد يسمعني')">باغي نهضر 💬</div>
            <div class="quick-reply" onclick="sendQuickReply('كنحس بالإكتئاب')">مزاج منخفض 😞</div>
        </div>

        <div class="ai-controls">
            <button class="ai-btn" onclick="enableResearchMode()">🔬 تفعيل البحث العلمي</button>
            <button class="ai-btn learning" onclick="showLearningStats()">📊 إحصائيات التعلم</button>
            <button class="ai-btn research" onclick="forceResearch()">🌐 بحث فوري</button>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input" id="chatInput">
                <input type="text" id="messageInput" placeholder="اسأل أي سؤال... سأبحث لك في آلاف المصادر العلمية" onkeypress="handleKeyPress(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Knowledge Sources Modal -->
    <div class="knowledge-sources" id="knowledgeModal">
        <div class="sources-panel">
            <h3>مصادر المعرفة المتاحة</h3>
            <div id="sourcesList">
                <div class="source-item">
                    <div class="source-title">American Journal of Psychiatry</div>
                    <div class="source-description">مجلة الطب النفسي الأمريكية - أحدث الأبحاث في العلاج النفسي والدوائي</div>
                    <div class="source-url">https://ajp.psychiatryonline.org/</div>
                </div>
                <div class="source-item">
                    <div class="source-title">Cognitive Behavioral Therapy Database</div>
                    <div class="source-description">قاعدة بيانات العلاج المعرفي السلوكي - تقنيات وممارسات مثبتة علمياً</div>
                    <div class="source-url">https://www.cbtdatabase.org/</div>
                </div>
                <div class="source-item">
                    <div class="source-title">WHO Mental Health Resources</div>
                    <div class="source-description">موارد منظمة الصحة العالمية للصحة النفسية</div>
                    <div class="source-url">https://www.who.int/mental_health/</div>
                </div>
                <div class="source-item">
                    <div class="source-title">PubMed Psychology Database</div>
                    <div class="source-description">قاعدة بيانات الأبحاث النفسية والطبية المراجعة من الأقران</div>
                    <div class="source-url">https://pubmed.ncbi.nlm.nih.gov/</div>
                </div>
            </div>
            <button onclick="closeKnowledgeSources()" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 10px; width: 100%; margin-top: 20px;">إغلاق</button>
        </div>
    </div>

    <script>
        // AI System Configuration
        let aiSystem = {
            isResearchMode: false,
            learningEnabled: true,
            knowledgeBase: {
                sources: 1247,
                sessions: 156,
                accuracy: 0.94,
                dailyLearning: 12
            },
            conversationMemory: [],
            userProfile: {
                commonTopics: [],
                preferredTreatments: [],
                responsePatterns: [],
                effectiveStrategies: []
            }
        };

        // Enhanced responses with research capabilities
        const aiResponses = {
            ar: {
                anxiety: [
                    "كنفهمك تماما، القلق كيخلي واحد يحس براسو تقيل وخايف. واش كاين شي حاجة معينة كتخليك قلق هاد الأيام؟ قول لي وحنا نشوفو كيفاش نخففو منها",
                    "القلق حاجة طبيعية وكلنا كنحسو بيه، ولكن ملي كيولي كثير كيأثر علينا. خود نفس عميق معايا... شهيق ببطء... زفير ببطء... مزيان! دابا قول لي شنو كيقلقك بالضبط",
                    "سمعتك ومع القلق ديالك. القلق صعيب بزاف وكيخلي الواحد يحس بحال ما عندوش تحكم. بغيت نفهم أكثر، واش هاد القلق جديد ولا كيجيك بزاف؟"
                ],
                loneliness: [
                    "الوحدة قاسحة بزاف، كنفهم هاد الإحساس وكيف كيخلي الواحد يحس بحال منسي. بغيت تهضر معايا على شنو كيخليك تحس براسك وحيد؟",
                    "مكاينش حتى واحد خاصو يحس براسو وحيد، وأنا هنا معاك دابا. الوحدة مشي معناها بلي معندكش قيمة، بل أحيانا كتجي حتى ملي كون محاطين بالناس.",
                    "الوحدة كتجي لكلشي وماشي عيب تحس بيها. المهم تعرف بلي كاين ناس كيبغيوك حتى لو ما كتحسش بيهم دابا."
                ],
                sleep: [
                    "مشاكل النوم كتأثر على كلشي - المزاج، التركيز، الطاقة. من إمتا وانت معندكش نعس مزيان؟ وشنو كتعمل قبل ما تنعس؟",
                    "النعس مهم بزاف للصحة النفسية والجسدية. واش كتشرب قهوة ولا أتاي بزاف؟ ولا كاين شي حاجة كتفكر فيها بالليل كتخليك صاحي؟",
                    "كنفهمك، بلا نعس كلشي كيولي صعيب والأفكار كتزيد. جرب تطفي التلفون والشاشات قبل منامك بساعة، وجرب تعمل تمارين التنفس العميق."
                ],
                depression: [
                    "الإكتئاب صعيب بزاف وكيخلي كلشي يبان بلا معنى. كنفهم بلي حتى الحوايج البسيطة كتولي صعيبة. من إمتا وكتحس بهاد الطريقة؟",
                    "شكرا ليك حيت شاركتي معايا هاد الإحساس الصعيب. الإكتئاب مرض حقيقي ومعندوش علاقة بالضعف. واش كاين أشياء صغيرة مازال كتعطيك شوية ديال الفرحة؟",
                    "الإكتئاب كيخلي الواحد يحس بحال غارق وماعندوش أمل. ولكن المهم تعرف بلي هاد المرحلة غادي تدوز."
                ],
                general: [
                    "كنسمعك بكل اهتمام. قول لي أكثر على اللي كتحس بيه ولا تخاف من أي حاجة",
                    "شكرا ليك حيت شاركتي معايا. ممكن توضح لي أكثر؟ وكيفاش هاد الموضوع كيأثر على حياتك اليومية؟",
                    "هادشي مهم واللي كتحس بيه مشروع. كيفاش كتعامل مع هاد الإحساس عادة؟"
                ],
                crisis: [
                    "كنشوف بلي كتعاني بزاف وهادشي كيخليني مقلق عليك. هادشي خطير ومهم جدا تهضر مع شي حد متخصص دابا. المرجو تواصل مع الخط الساخن: 0537-686464",
                    "صحتك النفسية أهم حاجة وأنا مقلق عليك. إلا كنتي كتفكر تأذي راسك، عافاك هضر مع شي حد قريب ليك دابا"
                ],
                encouragement: [
                    "كتبان لي قوي بزاف حيت قدرتي تشارك هادشي معايا. هادي خطوة كبيرة ومهمة! 💪",
                    "فخور بيك حيت كتحاول تحسن من راسك. مشي ساهل، ولكن راك فالطريق الصحيح وكل خطوة كتقدم",
                    "تذكر: حتى الأيام الصعيبة كتدوز. وغدا يجيب معاه أمل جديد وفرص جديدة 🌟"
                ]
            }
        };

        // Simulated research sources
        const researchSources = [
            {
                title: "Cognitive Behavioral Therapy for Anxiety Disorders",
                content: "الدراسات الحديثة تشير إلى فعالية العلاج المعرفي السلوكي في علاج اضطرابات القلق بنسبة 70-80%",
                journal: "Journal of Anxiety Disorders, 2024",
                url: "https://doi.org/10.1016/j.janxdis.2024.102891"
            },
            {
                title: "Mindfulness-Based Stress Reduction",
                content: "تقنيات اليقظة الذهنية تقلل من أعراض التوتر والاكتئاب بنسبة تصل إلى 58%",
                journal: "Psychological Medicine, 2024",
                url: "https://doi.org/10.1017/S0033291724000123"
            },
            {
                title: "Digital Mental Health Interventions",
                content: "التدخلات الرقمية للصحة النفسية تظهر نتائج واعدة في العلاج عن بعد",
                journal: "Nature Digital Medicine, 2024",
                url: "https://doi.org/10.1038/s41746-024-01001-x"
            }
        ];

        // Keywords for topic detection
        const keywords = {
            anxiety: ['قلق', 'مقلق', 'خايف', 'متوتر', 'قلقان', 'خوف'],
            loneliness: ['وحيد', 'وحدة', 'بوحدي', 'معنديش', 'منعزل'],
            sleep: ['نعس', 'منام', 'مكنقدرش', 'صاحي', 'أرق'],
            depression: ['مكتئب', 'حزين', 'إكتئاب', 'يأس', 'محبط'],
            stress: ['ضغط', 'متوتر', 'ضغوطات', 'مرهق', 'تعب'],
            crisis: ['نموت', 'منتحر', 'مكنقدرش نكمل', 'خلاص', 'نهاية']
        };

        // AI Functions
        function detectTopic(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [topic, words] of Object.entries(keywords)) {
                if (words.some(word => lowerMessage.includes(word))) {
                    return topic;
                }
            }
            return 'general';
        }

        function detectEmotion(message) {
            if (message.includes('حزين') || message.includes('مكتئب')) return 'sad';
            if (message.includes('قلق') || message.includes('خائف')) return 'anxious';
            if (message.includes('غاضب') || message.includes('متعصب')) return 'angry';
            if (message.includes('سعيد') || message.includes('مبسوط')) return 'happy';
            return 'neutral';
        }

        async function simulateResearch(query) {
            return new Promise((resolve) => {
                setTimeout(() => {
                    const relevantSources = researchSources.filter(source => 
                        query.includes('قلق') || query.includes('توتر') || query.includes('اكتئاب')
                    );
                    resolve(relevantSources.length > 0 ? relevantSources[0] : researchSources[0]);
                }, 2000 + Math.random() * 3000);
            });
        }

        async function getAIResponse(message) {
            showThinking();
            
            const needsResearch = shouldResearch(message);
            let researchData = null;
            
            if (needsResearch || aiSystem.isResearchMode) {
                showResearchActivity();
                researchData = await simulateResearch(message);
                hideResearchActivity();
            }
            
            hideThinking();
            learnFromConversation(message);
            
            return generateEnhancedResponse(message, researchData);
        }

        function shouldResearch(message) {
            const researchTriggers = [
                'أحدث', 'جديد', 'دراسة', 'بحث', 'علمي', 'طبي', 'فعالية', 'علاج'
            ];
            return researchTriggers.some(trigger => message.includes(trigger));
        }

        function generateEnhancedResponse(message, research) {
            const topic = detectTopic(message);
            let response = "";
            
            // Check for crisis
            if (topic === 'crisis') {
                document.getElementById('crisisBanner').style.display = 'block';
                return aiResponses.ar.crisis[Math.floor(Math.random() * aiResponses.ar.crisis.length)];
            }
            
            // Get appropriate response
            const topicResponses = aiResponses.ar[topic] || aiResponses.ar.general;
            response = topicResponses[Math.floor(Math.random() * topicResponses.length)];
            
            // Add research if available
            if (research) {
                response += `\n\n📚 من الأبحاث الحديثة: ${research.content}`;
                response += `\n🔬 المصدر: ${research.journal}`;
            }
            
            // Add encouragement occasionally
            if (Math.random() > 0.6) {
                const encouragement = aiResponses.ar.encouragement[Math.floor(Math.random() * aiResponses.ar.encouragement.length)];
                response += `\n\n${encouragement}`;
            }
            
            return response;
        }

        function learnFromConversation(message) {
            aiSystem.conversationMemory.push({
                message: message,
                timestamp: new Date(),
                topic: detectTopic(message),
                emotion: detectEmotion(message)
            });
            
            const topic = detectTopic(message);
            if (!aiSystem.userProfile.commonTopics.includes(topic)) {
                aiSystem.userProfile.commonTopics.push(topic);
            }
            
            aiSystem.knowledgeBase.sessions++;
            if (Math.random() > 0.7) {
                aiSystem.knowledgeBase.sources += Math.floor(Math.random() * 5) + 1;
            }
            
            updateLearningStats();
        }

        function showThinking() {
            document.getElementById('thinkingIndicator').style.display = 'flex';
        }

        function hideThinking() {
            document.getElementById('thinkingIndicator').style.display = 'none';
        }

        function showResearchActivity() {
            const activity = document.getElementById('researchActivity');
            const indicator = document.getElementById('researchIndicator');
            activity.classList.add('active');
            indicator.style.display = 'flex';
            
            const messages = [
                'جاري البحث في PubMed...',
                'تحليل الأبحاث من مجلة الطب النفسي...',
                'استخراج المعلومات من WHO...',
                'تجميع النتائج العلمية...'
            ];
            
            let index = 0;
            const interval = setInterval(() => {
                if (index < messages.length) {
                    activity.innerHTML = `🔍 ${messages[index]}`;
                    index++;
                } else {
                    clearInterval(interval);
                }
            }, 1000);
        }

        function hideResearchActivity() {
            document.getElementById('researchActivity').classList.remove('active');
            document.getElementById('researchIndicator').style.display = 'none';
        }

        function updateLearningStats() {
            document.getElementById('knowledgeCount').textContent = aiSystem.knowledgeBase.sources.toLocaleString();
            document.getElementById('sessionsCount').textContent = aiSystem.knowledgeBase.sessions;
            document.getElementById('accuracyRate').textContent = Math.round(aiSystem.knowledgeBase.accuracy * 100) + '%';
            document.getElementById('learningRate').textContent = '+' + aiSystem.knowledgeBase.dailyLearning;
        }

        // Control Functions
        function enableResearchMode() {
            aiSystem.isResearchMode = !aiSystem.isResearchMode;
            const chatInput = document.getElementById('chatInput');
            
            if (aiSystem.isResearchMode) {
                chatInput.classList.add('ai-mode');
                addSystemMessage('🔬 تم تفعيل البحث العلمي المتقدم - سأبحث في كل استفسار', 'research');
            } else {
                chatInput.classList.remove('ai-mode');
                addSystemMessage('⚡ الوضع السريع مُفعّل - استجابات فورية', 'research');
            }
        }

        function showLearningStats() {
            const panel = document.getElementById('learningPanel');
            panel.classList.toggle('active');
            
            if (panel.classList.contains('active')) {
                animateCounters();
            }
        }

        function forceResearch() {
            addSystemMessage('🌐 جاري البحث الفوري في جميع المصادر المتاحة...', 'research');
            
            setTimeout(async () => {
                const research = await simulateResearch('بحث عام');
                showKnowledgeUpdate(research);
            }, 2000);
        }

        function animateCounters() {
            const counters = ['sessionsCount', 'accuracyRate', 'learningRate'];
            counters.forEach(id => {
                const element = document.getElementById(id);
                const target = parseInt(element.textContent.replace(/[^0-9]/g, ''));
                let current = 0;
                const increment = target / 20;
                
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    
                    if (id === 'accuracyRate') {
                        element.textContent = Math.round(current) + '%';
                    } else if (id === 'learningRate') {
                        element.textContent = '+' + Math.round(current);
                    } else {
                        element.textContent = Math.round(current);
                    }
                }, 50);
            });
        }

        function addSystemMessage(text, type = 'research') {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${type}-avatar`;
            avatarDiv.textContent = type === 'research' ? '🔍' : '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function showKnowledgeUpdate(research) {
            const knowledgeBase = document.getElementById('knowledgeBase');
            knowledgeBase.innerHTML = `📚 تم إضافة: ${research.title} - ${research.journal}`;
            knowledgeBase.classList.add('show');
            
            setTimeout(() => {
                knowledgeBase.classList.remove('show');
            }, 5000);
            
            aiSystem.knowledgeBase.sources += Math.floor(Math.random() * 3) + 1;
            updateLearningStats();
        }

        function toggleKnowledgeSources() {
            document.getElementById('knowledgeModal').style.display = 'flex';
        }

        function closeKnowledgeSources() {
            document.getElementById('knowledgeModal').style.display = 'none';
        }

        // Messaging Functions
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addUserMessage(message);
            input.value = '';
            
            // Hide quick replies after first message
            document.getElementById('quickReplies').style.display = 'none';
            
            try {
                const response = await getAIResponse(message);
                addAIMessage(response);
            } catch (error) {
                console.error('AI Response Error:', error);
                addAIMessage('عذراً، حدث خطأ في النظام. جاري إعادة المحاولة...');
            }
        }

        function sendQuickReply(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar user-avatar';
            avatarDiv.textContent = '👤';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = text;
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function addAIMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar ai-avatar';
            avatarDiv.textContent = '🤖';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = text.replace(/\n/g, '<br>');
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);
            messagesContainer.appendChild(messageDiv);
            
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🤖 AI System Initialized');
            
            document.getElementById('learningStatus').textContent = 'نشط';
            updateLearningStats();
            document.getElementById('messageInput').focus();
            
            // Background learning simulation
            setInterval(() => {
                if (aiSystem.learningEnabled) {
                    aiSystem.knowledgeBase.dailyLearning = Math.floor(Math.random() * 5) + 10;
                    updateLearningStats();
                }
            }, 10000);
            
            console.log('✅ Self-learning AI therapy system ready!');
        });
    </script>
</body>
</html>